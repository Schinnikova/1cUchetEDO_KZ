<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=Edge' />
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <style>
        #loader-wrapper {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #loader-text {
            font: 24px Arial, sans-serif;
            color: black;
            margin-right: 20px;
        }

        .loader {
            width: 40px;
            height: 40px;
            position: relative;
        }

        .loader div {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #0078d4;
            border-radius: 50%;
            top: calc(16px + 16px * sin(var(--angle)));
            left: calc(16px + 16px * cos(var(--angle)));
            animation: spin 1.2s linear infinite;
            animation-delay: calc(var(--i) * -0.15s);
        }

        .loader div:nth-child(1) { --angle: 0deg; --i: 0; }
        .loader div:nth-child(2) { --angle: 45deg; --i: 1; }
        .loader div:nth-child(3) { --angle: 90deg; --i: 2; }
        .loader div:nth-child(4) { --angle: 135deg; --i: 3; }
        .loader div:nth-child(5) { --angle: 180deg; --i: 4; }
        .loader div:nth-child(6) { --angle: 225deg; --i: 5; }
        .loader div:nth-child(7) { --angle: 270deg; --i: 6; }
        .loader div:nth-child(8) { --angle: 315deg; --i: 7; }

        @keyframes spin {
            0% { opacity: 1; }
            50% { opacity: 0.3; }
            100% { opacity: 1; transform: rotate(360deg); }
        }

        .loaded #loader-wrapper {
            visibility: hidden;
            opacity: 0;
            transition: all 0.3s 1s ease-out;
        }

        .no-js #loader-wrapper { display: none; }
        .no-js h1 { color: #222222; }
    </style>
</head>
<body>
    <input type='hidden' id='signedData'>
    <input type='hidden' id='keyFile'>
    <input type='hidden' id='keyPass'>

    <div id='loader-wrapper'>
        <div id='loader-text'>Подписываем документы</div>
        <div class='loader'>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
            <div></div>
        </div>
    </div>

    <script lang='javascript' type='text/javascript'>
        var url = 'wss://127.0.0.1:13579/';
        var socket;
        var xmlData = '<data>Sign test</data>';

        function setSignedData(text) {
            document.getElementById('signedData').value = text;
            simulateClick();
        }

        function getSignedData() {
            return document.getElementById('signedData').value;
        }

        function simulateClick() {
            var event = new MouseEvent('click', {
                'view': window,
                'bubbles': true,
                'cancelable': true
            });
            document.dispatchEvent(event);
        }

        addEventListener('load', () => {
            socket = new WebSocket(url);

            socket.onopen = function () {
                signXML(xmlData);
                setTimeout(() => {
                    document.getElementById('loader-wrapper').classList.add('loaded');
                }, 3000);
            };

            socket.onclose = function (event) {
                if (event.wasClean) {
                    alert('Соединение закрыто чисто');
                } else {
                    alert('Обрыв соединения');
                }
                alert('Код: ' + event.code + ' причина: ' + event.reason);
            };

            socket.onerror = function (error) {
                alert('Ошибка ' + error.message);
            };

            socket.onmessage = function (event) {
                if (event.isTrusted) {
                    data = JSON.parse(event.data);
                    if (data.hasOwnProperty('responseObject')) {
                        setSignedData(data.responseObject);
                    } else {
                        if (data.hasOwnProperty('result')) {
                            if (!data.result.hasOwnProperty('version')) {
                                alert(event.data);
                            }
                        } else {
                            alert(event.data);
                        }
                    }
                }
            };
        });

        function signXML(xml) {
            var payload = {
                module: 'kz.gov.pki.knca.commonUtils',
                method: 'signXml',
                args: ['PKCS12', 'SIGN', xml, '', ''],
            };
            socket.send(JSON.stringify(payload));
        }
    </script>
</body>
</html>